## About

The image processing library is a template based library that provides basic image processing functions for streaming applications. The functions should at least support the OpenVX specification. Additionally, more data types and auto-vectorization are supported for all functions. Image data for the SDSoC functions can be in 8-bit, 16-bit or 32-bit fix-point representation (unsigned/signed). At this state, the library consists of two types of functions: windowed and pixel-wise operations.

## Provided Functions

The windowed operations are:
- Custom Convolution Filter
- Gaussian Convolution Filter
- Box Filter
- 3x3 Scharr Filter
- 3x3 Sobel Filter		
- 3x3 Median Filter

The windowed operations support different border handling:
- Replicated: Pixels beyond borders are replicated
- Constant: Pixels beyond borders are constant zero
- Undefined: Pixels beyond borders do not contain valid data

All functions are normalized to avoid overflow (below 1.0 for unsigned and between 0.5 and -0.5 for signed). All functions are optimized in their structure. E.g. a 5x5 gaussian convolution filter only has 6 different coefficients and therefore only needs 6 multiplication operations. The gaussian kernel coefficients are computed at compile time using the standard deviation and kernel size. They are computed using double precision floating point numbers, then normalized and converted to fixed point numbers. This computation does not consume extra resources  of the FPGA logic. The windowed functions will be optimized using separable filter functions in the next state.

The pixel-wise operations are:
- Absolute Difference
- Arithmetic Addition
- Arithmetic Subtraction
- Gradient Magnitude
- Pixel-wise Multiplication
- Bitwise And
- Bitwise Xor
- Bitwise Or
- Bitwise Not

Some arithmetic operations support conversion policies against overflow:
- Wrap: Results are the least significant bits of the output operand.
- Saturate: Results are saturated to the bit depth of the output operand.

Some arithmetic operations support rounding policies when scaling:
- Round to Zero: This truncates the least significant values that are lost in operations.
- Round to Nearest Even: This rounds to nearest even output value.

The Other operations are:
- Convert Bit Depth
- Convert Color
- Scale Down Image
- Integral Image
- Histogram
- Table Lookup

## Library Files:

The image processing library contains the following files:
- main.cpp: Contains examples of how to use the implemented functions. The example application shows a very efficient way to stream data between kernels (loop-level parallelism). All settings of the test program are in the first section of this file.
- img_filter_core.h:  Contains all sub-functions that are needed for the filter functions.
- img_filter_base.h:  Contains all filter functions. Call functions from here.
- img_filter_test.h:  Contains all test function, to test the functionality of the filter functions.
- img_pixelop_core.h: Contains all sub-functions that are needed for the pixel-wise operations.
- img_pixelop_base.h: Contains all pixel-wise operation functions. Call functions from here.
- img_pixelop_test.h: Contains all test function, to test the functionality of the pixel-wise operation functions.
- img_other_core.h:   Contains all sub-functions that are needed for the other operations.
- img_other_base.h:   Contains all other operation functions. Call functions from here.
- img_other_test.h:   Contains all test function, to test the functionality of the other functions.
- img_helper.h:       Contains global information like all enums/includes/defines. To run the source code outside of SDSoC, delete the define SDSOC at the beginning of this file.
- vx_types.h:         Contains global type definitions (imported from OpenVX)

## Usage

The library files explained in the previous sub-section can be used as follows:
- Add the "filter_base.h", "pixelop_base.h" and "img_other_core.h" to call functions.
- The "img_helper.h" and "vx_types.h" contains needed enums and defines.
- The "main.cpp" contains examples how to call the implemented functions.
- There is an example in the main for hardware efficient streaming in 1 accelerator. Streaming between functions by creating multiple accelerators as shown in the Xilinx guide only consumes unnecessary hardware.
- To use the built-in vectorization, image data needs to be casted to an unsigned data type bigger than the image data type. (vector_size = sizeof(vector_type / sizeof(data_type)). Due to the interface generated by Xilinx, it was not possible to cast internally.
- The "pragma SDS commands" in the main function are for interface creation and memory access.

## Latency

Clock cycles to compute 1 filter on 1 image:

kernel_radius = kernel_size / 2

vector_cols = image_cols / vector_size

window_cols = 2 * kernel_radius + vector_size + (vector_size - (kernel_radius % vector_size)) % vector_size

ohd_cols = (window_cols - kernel_radius) / vector_size - 1

clock_cycles = (image_rows + kernel_radius) * (vector_cols + ohd_cols) + pipeline_depth

- This function gives the same latency as in the HLS Report
- Unfortunately SDSoC slows down the speed due to memory access (SDSoC Report)
- The memory access pattern and interfaces are set by the "#pragma SDS commands"

## Advantage of vectorization

- Image resolution can be increased above FHD.
- Frequency can be reduced for an image resolution of FHD.
- Latency is reduced.	
- It would be nice to evaluate if reducing the frequency, while increasing the resource usage, leads to a more power efficient design!?

## Outlook

Further functionality will be added to the library:
- Add seperable filter functions
- Make functions more OpenVX compliant
- Change code to be fully embedded C/C++. Problem: template based functions
- Add further functions based on the OpenVX standard 1.0/1.1/1.2
	- Mean and Standard Deviation
	- Min, Max Location
	- Equalize Histogram	
